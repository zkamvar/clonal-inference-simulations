---
title: "Assessing equilibrium of simulations"
---

## Introduction

This notebook will show the index of association across generations at intervals
of 1,000 generations. In order to do this, all simulated files were uploaded to
the CGRB infastructure and were analyzed with `analyze_and_save_ia.R` with no
permutations. These were then saved in a directory called 
`ia_over_generations/`. The data for these values is in a directory on the
infastructure called `ia_over_generations_data/`, but is quite large (151GB).

## Setup

```{r, required_packages, message = FALSE}
library('zksimanalysis') # Main package for analysis
library('magrittr')      # For the %T>%
library('dplyr')         # Magic data manipulation
library('tidyr')         # more magic
library('purrr')         # magic dealing with lists
library('ggplot2')
library('gtable')
library('grid')
library('viridis')
```

## Data retrieval

The data were downloaded from the CGRB server using rsync with the following
command.

> Note: replace XXXXX with the port number. I am not writing it here for
security reasons.

```
rsync --update -tavz -e "ssh -p XXXXX" --exclude 'twenty_loci_results' \
kamvarz@files.cgrb.oregonstate.edu:/nfs1/BPP/Grunwald_Lab/home/kamvarz/simulation_analysis/results/ \
../simulation_results/
```

## Preparing Data

First the data from the first round of simulations with 6-10 alleles per locus.

```{r data_preparation, results = "hide"}
datfiles  <- dir(here::here("data", "ia_over_generations_n1000/"), full.names = TRUE)
locfiles  <- dir(here::here("data", "locus_diversity_over_generations_n1000/"), full.names = TRUE)
datnames  <- setNames(datfiles, datfiles)
locnames  <- setNames(locfiles, locfiles)
for (i in datfiles){
  datnames[i] <- load(i)
}
for (i in locfiles){
  locnames[i] <- load(i)
}

account_for_source <- . %>%
  map_df(get, .id = "source") %>% # map the `get()` function and return a tibble
  mutate(mutation_rate = ifelse(grepl("mutant", source), "even", "uneven")) %>%
  mutate(source = gsub("(^.+?feather).*$", "\\1.DATA.rda", source))

ex_run  <- "high_mutation([0-9]+?)/"
ex_seed <- "seed_([0-9]+?)_"
ex_sex  <- "sex_([0-9.]+?)_"
ex_gen  <- "gen_([0-9]+?)_"
ex_rep  <- "rep_([0-9]+?).pop"
ex_samp <- "_sam_([0-9]+?)$"

datalist <- datnames %>%
  setNames(datnames) %>%          # set the names for binding id
  account_for_source %>%
  tidyr::extract(pop, c("run", "seed", "sexrate", "gen", "rep", "sample"),
          paste0(ex_run, ex_seed, ex_sex, ex_gen, ex_rep, ex_samp),
          remove = FALSE) %>%
  mutate(sample = factor(sample, unique(sample))) # Transform the sample to a factor

datalist <- locnames %>%
  setNames(locnames) %>%          # set the names for binding id
  account_for_source %>%
  inner_join(datalist, by = c("pop", "source", "mutation_rate"))


rm(list = datnames)
rm(list = locnames)
gc()
datalist
```

```{r data_preparation_more_alleles, results = "hide"}
datfiles  <- dir(here::here("data", "ia_over_generations_n1000_more_alleles/"), full.names = TRUE)
locfiles  <- dir(here::here("data", "locus_diversity_over_generations_n1000_more_alleles/"), full.names = TRUE)
datnames  <- setNames(datfiles, datfiles)
locnames  <- setNames(locfiles, locfiles)
for (i in datfiles){
  datnames[i] <- load(i)
}
for (i in locfiles){
  locnames[i] <- load(i)
}

account_for_source <- . %>%
  map_df(get, .id = "source") %>% # map the `get()` function and return a tibble
  mutate(mutation_rate = ifelse(grepl("mutant", source), "even", "uneven")) %>%
  mutate(source = gsub("(^.+?feather).*$", "\\1.DATA.rda", source))

ex_run  <- "more_alleles_high_mutation([0-9]+?)/"
ex_seed <- "seed_([0-9]+?)_"
ex_sex  <- "sex_([0-9.]+?)_"
ex_gen  <- "gen_([0-9]+?)_"
ex_rep  <- "rep_([0-9]+?).pop"
ex_samp <- "_sam_([0-9]+?)$"

datalist_ma <- datnames %>%
  setNames(datnames) %>%          # set the names for binding id
  account_for_source %>%
  tidyr::extract(pop, c("run", "seed", "sexrate", "gen", "rep", "sample"),
          paste0(ex_run, ex_seed, ex_sex, ex_gen, ex_rep, ex_samp),
          remove = FALSE) %>%
  mutate(sample = factor(sample, unique(sample))) # Transform the sample to a factor

datalist_ma <- locnames %>%
  setNames(locnames) %>%          # set the names for binding id
  account_for_source %>%
  inner_join(datalist_ma, by = c("pop", "source", "mutation_rate"))


rm(list = datnames)
rm(list = locnames)
gc()
datalist_ma
```

## Plotting

Now that we have the data, we can visualize the stability of the simulations
over generations. 


```{r, fig.height = 4.5, fig.width = 12}
old_theme <- theme_set(theme_bw(base_size = 16, base_family = "Helvetica"))
old_theme <- theme_update(axis.text.x = element_text(angle = 90, vjust = 0.5))
sample_colors <- scale_color_viridis(discrete = TRUE, direction = -1, option = "D")
iaplot <- datalist %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(rbarD = mean(rbarD, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = rbarD, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = expression(bar(r)[d]),
    x = "generation (x1000)",
    title = "Index of association over 10,000 generations",
    subtitle = "6 to 10 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
iaplot_ma <- datalist_ma %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(rbarD = mean(rbarD, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = rbarD, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = expression(bar(r)[d]),
    x = "generation (x1000)",
    title = "Index of association over 10,000 generations",
    subtitle = "10 to 20 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
iaplot
iaplot_ma
```


If we looked at allelic diversity statistics:


```{r, fig.height = 4.5, fig.width = 12}
Hexpplot <- datalist %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(Hexp = mean(Hexp, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = Hexp, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = expression(H[exp]),
    x = "generation (x1000)",
    title = "Nei's Gene Diversity over 10,000 generations",
    subtitle = "6 to 10 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
Hexpplot
Hexpplot_ma <- datalist_ma %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(Hexp = mean(Hexp, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = Hexp, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = expression(H[exp]),
    x = "generation (x1000)",
    title = "Nei's Gene Diversity over 10,000 generations",
    subtitle = "10 to 20 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
Hexpplot_ma
Evenplot <- datalist %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(Evenness = mean(Evenness, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = Evenness, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = expression(E[5][A]),
    x = "generation (x1000)",
    title = "Evenness over 10,000 generations",
    subtitle = "6 to 10 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
Evenplot
Evenplot_ma <- datalist_ma %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(Evenness = mean(Evenness, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = Evenness, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = expression(E[5][A]),
    x = "generation (x1000)",
    title = "Evenness over 10,000 generations",
    subtitle = "10 to 20 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
Evenplot_ma
Alleleplot <- datalist %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(allele = mean(allele, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = allele, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = "Mean number of alleles",
    x = "generation (x1000)",
    title = "Mean number of alleles over 10,000 generations",
    subtitle = "6 to 10 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
Alleleplot
Alleleplot_ma <- datalist_ma %>%
  mutate(gen = round(as.numeric(gen), -3)/1000) %>%
  mutate(runseed = paste(run, seed)) %>%
  group_by(sexrate, gen, sample, mutation_rate, runseed) %>%
  summarize(allele = mean(allele, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = gen, y = allele, group = runseed, color = runseed)) +
  geom_line(alpha = 0.25) +
  facet_grid(mutation_rate ~ sexrate) +
  scale_x_continuous(breaks = c(2, 4, 6, 8)) +
  sample_colors +
  theme(text = element_text(size = 16)) +
  theme(strip.text = element_text(size = 16)) +
  theme(aspect.ratio = 0.75) +
  theme(panel.spacing = unit(0, "line")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  theme(legend.position = "none") +
  labs(list(
    y = "Mean number of alleles",
    x = "generation (x1000)",
    title = "Mean number of alleles over 10,000 generations",
    subtitle = "10 to 20 alleles per locus",
    caption = "\nValues for 100 unique seed summarized over 10 replicates"
  ))
Alleleplot_ma
```

## Session Information

```{r session_info}
options(width = 100)
devtools::session_info()
```
