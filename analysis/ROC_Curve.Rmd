---
title: "ROC Analysis"
author: "Zhian N. Kamvar"
date: "October 16, 2016"
output: html_document
---

## Introduction

I've created 10,000 simulations of populations undergoing different levels of
sexual reproduction and analyzed the index of association along with genotypic
and allelic diversity metrics, including an analysis of the contribution of each
locus to the genotypic diversity. 

This document will perform a power analysis of $\bar{r}_d$ by calculating
Receiver Operator Characteristic (ROC) Curves. These curves are useful in
assessing the power of an analysis by assessing the true positive fraction and
false positive fraction against different values of $\alpha$. 

In our case, we are asking the question:

> How well can $\bar{r}_d$ detect non-random mating (clonal reproduction)?


## Analysis

### Overall ROC Curve

We will be looking at factors such as sample size, percent of clonal 
reproduction, and variable mutation rates. To perform the analyis, the data will
be split up into two sets: "Random Mating" and "Non-Random Mating". The Random 
mating set will always be the data set where the sex rate is one. This will
serve to assess our Type 1 (False Positive) fraction. The Non-Random mating
component will each rate of sexual reproduction less than one. In this data set,
that means that 9 total ROC curves will be produced for each overall comparison.

### ROC Curve by Seed

Since we simulated the populations in a way such that each parent population is
one of 10 replicates spawned from 100 unique seeds across rates of sexual
reproduction, we can group the populations by seed and calculate an ROC Curve
for each seed.

### Area Under the ROC Curve (AURC)

The Area under the ROC Curve will be calcuated via the `auc()` function via
*flux*. 

## Setup

```{r, required_packages}
library('zksimanalysis')
```

This here will load in all of the results of the analyses. These were previously
processed in the file `ssr_data_cleaning.Rmd`. The name of the data was called
"vals".

```{r, load_data, cache = TRUE, results = "hide", cache.lazy = FALSE}
system.time({
res           <- load("../../simulation_results/processed_results.rda")
even_mutation <- vals %>% filter(mutation_rate == "even")
odd_mutation  <- vals %>% filter(mutation_rate == "uneven")
})
res
even_mutation
odd_mutation
```

## Data Analysis

### Overall ROC Calculation

```{r, generate_sexrate}
sex <- unique(vals$sexrate)
sex <- sex[!sex %in% "1.0000"]
alpha <- seq(0, 1, by = 0.01)
```


```{r, roc_overall, cache = TRUE}
roc_overall <- sex %>% map(map2, alpha,
            ~roc(.y, vals, compare = c(.x, "1.0000"), count.na = TRUE,
                group = c("mutation_rate", "sexrate", "sample")
                )) %>%
  flatten() %>%
  bind_rows(.id = "sex") %>%
  ungroup() %>%
  spread(score, positive_fraction)
roc_overall

roc_overall_cc <- sex %>% map(map2, alpha,
            ~roc(.y, vals, compare = c(.x, "1.0000"), stat = "p.rDcc", 
                 count.na = TRUE, group = c("mutation_rate", "sexrate", "sample")
                )) %>%
  flatten() %>%
  bind_rows(.id = "sex") %>%
  ungroup() %>%
  spread(score, positive_fraction)
roc_overall_cc

```


```{r, curves, fig.width = 10, fig.height = 10}
old_theme <- theme_set(theme_bw())
ggplot(roc_overall, aes(x = `False Positive`, y = `True Positive`, 
                        color = sample)) +
  geom_line(aes(lty = mutation_rate)) +
  # geom_point(aes(pch = sample)) +
  facet_wrap(~sexrate) +
  geom_abline(slope = 1, lty = 3) +
  labs(list(
    title = "ROC Curves over sex rate",
    lty = "Mutation Rate",
    pch = "Sample Size",
    color = "Sample Size"
  )) +
  theme(aspect.ratio = 1) +
  scale_color_brewer(palette = "Set1")
ggplot(roc_overall_cc, aes(x = `False Positive`, y = `True Positive`, 
                        color = sample)) +
  geom_line(aes(lty = mutation_rate)) +
  # geom_point(aes(pch = sample)) +
  facet_wrap(~sexrate) +
  geom_abline(slope = 1, lty = 3) +
  labs(list(
    title = "ROC Curves over sex rate (clone-corrected)",
    lty = "Mutation Rate",
    pch = "Sample Size",
    color = "Sample Size"
  )) +
  theme(aspect.ratio = 1) +
  scale_color_brewer(palette = "Set1")
```

```{r, roc_by_seed, cache = TRUE}
roc_by_seed <- sex %>% map(map2, alpha,
            ~roc(.y, vals, compare = c(.x, "1.0000"), count.na = TRUE,
                group = c("mutation_rate", "sexrate", "run", "seed", "sample")
                )) %>%
  flatten() %>%
  bind_rows(.id = "runseed") %>%
  ungroup() %>%
  spread(score, positive_fraction)
roc_by_seed
roc_by_seed_cc <- sex %>% map(map2, alpha,
            ~roc(.y, vals, compare = c(.x, "1.0000"), count.na = TRUE, stat = "p.rDcc",
                group = c("mutation_rate", "sexrate", "run", "seed", "sample")
                )) %>%
  flatten() %>%
  bind_rows(.id = "runseed") %>%
  ungroup() %>%
  spread(score, positive_fraction)
roc_by_seed_cc
```

### AURC

Here we calculate the Area Under the ROC Curve using the function `auc()` from
the package *flux*.

```{r, AURC_calc, cache = TRUE}
# Calculate ROC over all seeds, produce points
overall_roc <- . %>% 
  group_by(sexrate, sample, mutation_rate) %>%
  summarize(AURC = auc(`False Positive`, `True Positive`))

# Calculate ROC for each seed separately, produce distributions
by_seed_roc <- . %>% 
  group_by(run, seed, sexrate, sample, mutation_rate) %>%
  summarize(AURC = auc(`False Positive`, `True Positive`))

AURC_overall <- roc_overall %>% overall_roc
AURC_by_seed <- roc_by_seed %>% by_seed_roc

AURC_overall_cc <- roc_overall_cc %>% overall_roc
AURC_by_seed_cc <- roc_by_seed_cc %>% by_seed_roc

# Combine clone-corrected and un-corrected
by_seed <- bind_rows(AURC_by_seed_cc, AURC_by_seed, .id = "CC") %>%
  mutate(CC = ifelse(CC == 1, "clone-corrected", "uncorrected")) %>%
  ungroup() %>% 
  mutate(sample = factor(paste("n =", sample), paste("n =", c(10, 25, 50, 100))))

overall <- bind_rows(AURC_overall_cc, AURC_overall, .id = "CC") %>%
  mutate(CC = ifelse(CC == 1, "clone-corrected", "uncorrected")) %>%
  ungroup() %>% 
  mutate(sample = factor(paste("n =", sample), paste("n =", c(10, 25, 50, 100))))

```

Now we can visualize the data as facetted boxplots

```{r, AURC_plot, fig.width = 10, fig.height = 10}

# Add an annotation indicating that 0.5 is random assignment.
text_annotation <- data.frame(x = 0, y = 0.5, text = "0.5 = random", 
                              sample = "n = 10", mutation_rate = "even")

ggplot(by_seed, aes(x = factor(sexrate), y = AURC)) +
  geom_boxplot(aes(fill = CC)) +
  annotate("rect", xmin = 0, xmax = 9.75, ymin = 0, ymax = 0.5, alpha = .2) +
  geom_boxplot(aes(fill = CC)) +
  facet_grid(sample~mutation_rate) +
  geom_text(aes(x = x, y = y, label = text), hjust = -0.1, vjust = 1.5, color = "gray25",
            data = text_annotation) +
  geom_point(aes(x = factor(sexrate), y = AURC, pch = CC), data = overall,
             position = position_dodge(width = 0.75), color = "black", fill = "white") +
  scale_shape_manual(values = c(21, 24)) + 
  labs(list(
    fill = "Clone Correction",
    pch = "Overall",
    x = "Rate of Sexual Reproduction",
    title = expression(paste("Area Under the ROC Curve for ", bar(r)[d])),
    subtitle = "calculated over sample size and mutation rate"
  )) +
  scale_fill_brewer(palette = "Set2")


```


## Session Information

```{r session_info}
options(width = 100)
devtools::session_info()
```

